name: "CodeQL Advanced Scanning"

on:
  workflow_call:
    inputs:
      build-modes:
        description: "JSON map of language to build-mode (autobuild, manual, none) e.g.'{\"csharp\":\"manual\"}'"
        type: string
        default: "{}"
      codeql-config:
        description: "CodeQL config file reference."
        type: string
        default: "moonpig-spike/SPIKE-WORKFLOW-TEST/codeql/codeql-config.yaml@master"
    secrets:
      MNPG_GITHUB_READ_APP_ID:
        required: true
      MNPG_GITHUB_READ_APP_PEM_FILE:
        required: true
      MNPG_CODEQL_SLACK_WEBHOOK_URL:
        required: false

jobs:
  create-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.languages }}
    steps:
      - name: Get languages from repo
        id: set-matrix
        uses: advanced-security/set-codeql-language-matrix@v1
        with:
          access-token: ${{ secrets.GITHUB_TOKEN }}
          endpoint: ${{ github.event.repository.languages_url }}

  analyze:
    needs: create-matrix
    if: ${{ needs.create-matrix.outputs.matrix != '[]' }}
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      # required for all workflows
      security-events: write
      # only required for workflows in private repositories
      actions: read
      contents: read
      # required to fetch internal or private CodeQL packs
      packages: read

    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJSON(needs.create-matrix.outputs.matrix) }}

    steps:
      - name: Generate GH App Token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.MNPG_GITHUB_READ_APP_ID }}
          owner: ${{ github.repository_owner }}
          private-key: ${{ secrets.MNPG_GITHUB_READ_APP_PEM_FILE }}
          repositories: "moonpig-ops-pipeline-workflows"

      - if: ${{ matrix.language == 'csharp' }}
        name: Setup Nuget Source
        uses: moonpig/moonpig-ops-pipeline-workflows/.github/actions/dotnet-nuget-setup@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          config-file: ${{ inputs.codeql-config }}
          external-repository-token: ${{ steps.generate-token.outputs.token }}
          languages: ${{ matrix.language }}
          build-mode: ${{ fromJSON(inputs.build-modes)[matrix.language] || 'none' }}

      - if: ${{ fromJSON(inputs.build-modes)[matrix.language] == 'manual' }}
        id: check-codeql-build-action
        name: Check if custom build action exists
        run: |
          if [ ! -d ".github/actions/codeql-build" ]; then
            echo "‚ùå Error: Custom build action not found at .github/actions/codeql-build"
            echo "Please create the custom build action and include steps to build the ${{ matrix.language }} application."
            exit 1
          fi

      - if: ${{ fromJSON(inputs.build-modes)[matrix.language] == 'manual' }}
        name: Build ${{ matrix.language }} application
        uses: ./.github/actions/codeql-build
        with:
          language: ${{ matrix.language }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"

      - if: ${{always() && (failure() || cancelled())}}
        name: Slack Notification
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.MNPG_CODEQL_SLACK_WEBHOOK_URL }}
          webhook-type: webhook-trigger
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üö®  CodeQL Analyze `${{ matrix.language }}` Job Failed:* <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}| ${{ github.repository }}>"
                  }
                }
              ]
            }
